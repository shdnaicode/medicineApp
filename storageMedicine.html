<!doctype html>
<html lang="th">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>คลังยา</title>
		<link rel="stylesheet" href="styling.css" />
		<style>
			@import url("https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap");
		</style>
	</head>
	<body>
		<header class="headerBar">
			<div class="innerHeaderBar">
				<h1 class="innerHeaderTitle">โรงพยาบาลพุทธโสธร</h1>
			</div>
		</header>

		<main class="pageContainer">
			<section class="card">
				<div class="cardHeader">
					<h2 class="cardTitle">คลังยาสมุนไพร</h2>
					<a class="linkButton" href="index.html">กลับหน้าหลัก</a>
				</div>

				<div class="searchRow">
					<label class="field" style="flex: 1">
						<span class="label">ค้นหาสมุนไพร</span>
						<input
							class="input"
							type="search"
							id="searchInput"
							placeholder="พิมพ์ชื่อสมุนไพร..."
							autocomplete="off"
						/>
					</label>
					<button class="secondaryButton" type="button" id="clearSearchBtn">ล้าง</button>
				</div>

				<div class="stockEntry" aria-label="เพิ่มสมุนไพรเข้าคลังยา">
					<label class="field">
						<span class="label">เพิ่มสมุนไพรใหม่</span>
						<input class="input" type="text" id="newHerbName" placeholder="เช่น ฟ้าทะลายโจร" />
					</label>
					<label class="field">
						<span class="label">ส่วน</span>
						<input class="input" type="text" id="newHerbPart" placeholder="เช่น ใบ / ราก" />
					</label>
					<label class="field">
						<span class="label">น้ำหนักก่อนอบ</span>
						<input
							class="input"
							type="number"
							id="newHerbWeight"
							min="0"
							step="0.01"
							placeholder="กรอกตัวเลข (กรัม)"
						/>
					</label>
					<button class="primaryButton" type="button" id="addHerbBtn">เพิ่มเข้าคลัง</button>
				</div>
				<div id="stockHint" class="sectionHint" style="margin-top: 6px">
					หมายเหตุ: การแก้ไข/เพิ่มข้อมูลจะบันทึกในเครื่อง (localStorage) และถูกใช้เป็นแหล่งอ้างอิงในหน้า “สั่งยา”
				</div>

				<div class="tableWrap">
					<table class="table" aria-label="ผลการค้นหาสมุนไพร">
						<thead>
							<tr>
								<th>ชื่อสมุนไพร</th>
								<th>ส่วน</th>
								<th>น้ำหนักก่อนอบ</th>
								<th>จัดการ</th>
							</tr>
						</thead>
						<tbody id="resultBody">
							<tr class="emptyRow" id="emptyRow">
								<td colspan="4">ไม่พบข้อมูล</td>
							</tr>
						</tbody>
					</table>
				</div>
			</section>
		</main>

		<script src="herbStockSeed.js"></script>
		<script src="appData.js"></script>
		<script>
			const searchInput = document.getElementById("searchInput");
			const clearSearchBtn = document.getElementById("clearSearchBtn");
			const resultBody = document.getElementById("resultBody");
			const emptyRow = document.getElementById("emptyRow");
			const newHerbName = document.getElementById("newHerbName");
			const newHerbPart = document.getElementById("newHerbPart");
			const newHerbWeight = document.getElementById("newHerbWeight");
			const addHerbBtn = document.getElementById("addHerbBtn");

			const seed = Array.isArray(window.MEDICINEAPP_HERB_STOCK_SEED)
				? window.MEDICINEAPP_HERB_STOCK_SEED
				: [];
			window.MedicineAppData?.ensureHerbStockSeed(seed);

			function normalize(text) {
				return window.MedicineAppData?.normalize(text) ?? String(text ?? "").trim().toLowerCase();
			}

			function formatWeight(value) {
				if (value == null) return "-";
				const n = Number(value);
				if (!Number.isFinite(n)) return "-";
				return n.toLocaleString("th-TH");
			}

			/** @type {{name: string, part: string, weightBeforeDry: number | null}[]} */
			let allRows = window.MedicineAppData?.loadHerbStock() ?? [];

			function persist() {
				window.MedicineAppData?.saveHerbStock(allRows);
			}

			function render(rows) {
				resultBody.querySelectorAll("tr[data-row]").forEach((r) => r.remove());

				if (!Array.isArray(rows) || rows.length === 0) {
					emptyRow.style.display = "table-row";
					return;
				}
				emptyRow.style.display = "none";

				rows.forEach((row, idx) => {
					const tr = document.createElement("tr");
					tr.dataset.row = String(idx);

					const tdName = document.createElement("td");
					tdName.textContent = row.name;

					const tdPart = document.createElement("td");
					tdPart.textContent = row.part || "-";

					const tdWeight = document.createElement("td");
					const weightInput = document.createElement("input");
					weightInput.className = "input tableInput";
					weightInput.type = "number";
					weightInput.min = "0";
					weightInput.step = "0.01";
					weightInput.inputMode = "decimal";
					weightInput.placeholder = "-";
					weightInput.value = row.weightBeforeDry == null ? "" : String(row.weightBeforeDry);
					weightInput.addEventListener("input", () => {
						const n = Number(weightInput.value);
						row.weightBeforeDry = weightInput.value === "" ? null : Number.isFinite(n) ? n : null;
					});
					tdWeight.appendChild(weightInput);

					const tdAction = document.createElement("td");
					tdAction.className = "tableAction";
					const saveBtn = document.createElement("button");
					saveBtn.type = "button";
					saveBtn.className = "secondaryButton";
					saveBtn.textContent = "บันทึก";
					saveBtn.addEventListener("click", () => {
						persist();
					});
					const delBtn = document.createElement("button");
					delBtn.type = "button";
					delBtn.className = "dangerButton";
					delBtn.style.marginLeft = "8px";
					delBtn.textContent = "ลบ";
					delBtn.addEventListener("click", () => {
						if (!confirm(`ลบรายการ “${row.name}” ออกจากคลังยา?`)) return;
						allRows = allRows.filter((r) => r !== row);
						persist();
						applySearch();
					});
					tdAction.appendChild(saveBtn);
					tdAction.appendChild(delBtn);

					tr.appendChild(tdName);
					tr.appendChild(tdPart);
					tr.appendChild(tdWeight);
					tr.appendChild(tdAction);
					resultBody.appendChild(tr);
				});
			}

			function applySearch() {
				// Reload latest data for consistency across tabs/pages
				allRows = window.MedicineAppData?.loadHerbStock() ?? allRows;
				const q = normalize(searchInput.value);
				if (!q) {
					render(allRows);
					return;
				}
				const filtered = allRows.filter(
					(r) => normalize(r.name).includes(q) || normalize(r.part).includes(q),
				);
				render(filtered);
			}

			function addHerb() {
				const name = newHerbName.value.trim();
				const part = newHerbPart.value.trim();
				const weightRaw = newHerbWeight.value;

				if (!name) {
					newHerbName.focus();
					return;
				}

				// prevent duplicates (by normalized name)
				allRows = window.MedicineAppData?.loadHerbStock() ?? allRows;
				const exists = allRows.some((r) => normalize(r.name) === normalize(name));
				if (exists) {
					alert("มีสมุนไพรชื่อนี้อยู่แล้วในคลังยา");
					return;
				}

				let weightBeforeDry = null;
				if (weightRaw !== "") {
					const n = Number(weightRaw);
					if (!Number.isFinite(n) || n < 0) {
						newHerbWeight.focus();
						return;
					}
					weightBeforeDry = n;
				}

				allRows.unshift({ name, part, weightBeforeDry });
				persist();
				newHerbName.value = "";
				newHerbPart.value = "";
				newHerbWeight.value = "";
				searchInput.value = "";
				applySearch();
				newHerbName.focus();
			}

			searchInput.addEventListener("input", applySearch);
			clearSearchBtn.addEventListener("click", () => {
				searchInput.value = "";
				applySearch();
				searchInput.focus();
			});
			addHerbBtn.addEventListener("click", addHerb);
			newHerbWeight.addEventListener("keydown", (e) => {
				if (e.key === "Enter") {
					e.preventDefault();
					addHerb();
				}
			});

			render(allRows);
		</script>
	</body>
</html>
